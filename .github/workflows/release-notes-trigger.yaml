name: Trigger Release Notes Generation
on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name (e.g., v1.0.1)'
        required: true
        type: string
jobs:
  call-api-gateway:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Extract tag details
        id: taginfo
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG_NAME="${{ github.event.inputs.tag_name }}"
          else
            TAG_NAME="${GITHUB_REF#refs/tags/}"
          fi
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT

          RELEASE_URL="https://github.com/${GITHUB_REPOSITORY}/releases/tag/${TAG_NAME}"
          echo "release_url=$RELEASE_URL" >> $GITHUB_OUTPUT
          
      - name: Prepare JSON payload
        id: prepare_payload
        run: |
          cat <<EOF > payload.json
          {
            "releaseUrl": "${{ steps.taginfo.outputs.release_url }}",
            "tagName":    "${{ steps.taginfo.outputs.tag_name }}",
            "targetEmails": [${EMAIL_LIST}],
            "snsArn":     "${SNS_ARN}"
          }
          EOF
        env:
          EMAIL_LIST: ${{ secrets.RELEASE_NOTIFY_EMAILS }}   # example: "\"dev@x.com\",\"team@x.com\""
          SNS_ARN: ${{ secrets.RELEASE_SNS_ARN }}

      - name: Debug API configuration
        run: |
          echo "API Gateway URL: ${{ secrets.API_GATEWAY_URL }}/trigger"
          echo "API Key length: ${#API_KEY}"
        env:
          API_KEY: ${{ secrets.API_GATEWAY_KEY }}

      - name: Call API Gateway to trigger release notes generation
        run: |
          curl -X POST \
               -H "x-api-key: ${{ secrets.API_GATEWAY_KEY }}" \
               -H "Content-Type: application/json" \
               -d @payload.json \
               "${{ secrets.API_GATEWAY_URL }}/trigger" \
               -v

      - name: Show request Payload
        if: always()
        run: cat payload.json