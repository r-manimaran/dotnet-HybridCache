name: Trigger Release Notes Generation
on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name (e.g., v1.0.1)'
        required: true
        type: string
jobs:
  call-api-gateway:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Extract tag details
        id: taginfo
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG_NAME="${{ github.event.inputs.tag_name }}"
          else
            TAG_NAME="${GITHUB_REF#refs/tags/}"
          fi
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT

          RELEASE_URL="https://github.com/${GITHUB_REPOSITORY}/releases/tag/${TAG_NAME}"
          echo "release_url=$RELEASE_URL" >> $GITHUB_OUTPUT
          
      - name: Prepare JSON payload
        id: prepare_payload
        run: |
         # Create the inner payload first
          INNER_PAYLOAD=$(cat <<EOF
          {
            "releaseUrl": "${{ steps.taginfo.outputs.release_url }}",
            "tagName": "${{ steps.taginfo.outputs.tag_name }}",
            "targetEmails": [${EMAIL_LIST}],
            "snsArn": "${SNS_ARN}"
          }
          EOF
          )
          
          # Create the Lambda proxy format
          cat <<EOF > payload.json
          {
            "resource": "/",
            "path": "/",
            "httpMethod": "POST",
            "headers": {
              "Content-Type": "application/json"
            },
            "multiValueHeaders": {},
            "queryStringParameters": null,
            "multiValueQueryStringParameters": null,
            "pathParameters": null,
            "stageVariables": null,
            "requestContext": {
              "resourceId": "123456",
              "resourcePath": "/",
              "httpMethod": "POST",
              "extendedRequestId": "c6af9ac6-7b61-11e6-9a41-93e8deadbeef",
              "requestTime": "$(date -u '+%d/%b/%Y:%H:%M:%S +0000')",
              "path": "/Prod/",
              "accountId": "123456789012",
              "protocol": "HTTP/1.1",
              "stage": "Prod",
              "domainPrefix": "1234567890",
              "requestTimeEpoch": $(date +%s)000,
              "requestId": "c6af9ac6-7b61-11e6-9a41-93e8deadbeef",
              "identity": {
                "sourceIp": "127.0.0.1",
                "userAgent": "GitHub-Actions"
              },
              "domainName": "1234567890.execute-api.us-east-1.amazonaws.com",
              "apiId": "1234567890"
            },
            "body": "$(echo "$INNER_PAYLOAD" | sed 's/"/\\"/g' | tr -d '\n')",
            "isBase64Encoded": false
          }
          EOF
        env:
          EMAIL_LIST: ${{ secrets.RELEASE_NOTIFY_EMAILS }}   # example: "\"dev@x.com\",\"team@x.com\""
          SNS_ARN: ${{ secrets.RELEASE_SNS_ARN }}

      - name: Debug API configuration
        run: |
          echo "API Gateway URL: ${{ secrets.API_GATEWAY_URL }}/trigger"
          echo "API Key length: ${#API_KEY}"
        env:
          API_KEY: ${{ secrets.API_GATEWAY_KEY }}

      - name: Call API Gateway to trigger release notes generation
        run: |
          curl -X POST \
               -H "x-api-key: ${{ secrets.API_GATEWAY_KEY }}" \
               -H "Content-Type: application/json" \
               -d @payload.json \
               "${{ secrets.API_GATEWAY_URL }}/trigger" \
               -v

      - name: Show request Payload
        if: always()
        run: cat payload.json